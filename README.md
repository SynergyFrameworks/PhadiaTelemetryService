# Demo Phadia Telemetry Service

## Service Summary:
The Phadia Telemetry Service is a Windows background service designed to interface with the Phadia 2500 Laboratory System, a high-throughput automated system for allergy and autoimmunity testing. This service processes the output files generated by the Phadia 2500, transmitting the data for storage and further analysis.

## Key Points:

1. Data Source: 
   - The service processes files output by the Phadia 2500 Laboratory System.
   - These files contain crucial allergy and autoimmunity test results.

2. File Processing:
   - The service monitors a specified directory for new files from the Phadia 2500.
   - It handles both XML and JSON file formats, providing flexibility in data output.

3. Data Transmission:
   - Processed data is sent to an Azure Event Hub for high-volume data ingestion.
   - Data is also sent to a gRPC endpoint, allowing for real-time data streaming to other services.

4. Analytical Services Integration:
   - Transmitting data to Event Hub and gRPC endpoints enables integration with multiple analytical services.
   - This setup allows for real-time analysis, batch processing, or both.

5. Resilience and Scalability:
   - The service implements retry mechanisms and circuit breakers to ensure reliable data transmission.
   - Use of Azure Event Hub allows for scalable data ingestion.

6. Monitoring and Logging:
   - Extensive logging to Elasticsearch allows for monitoring of the data flow.
   - Metrics tracking helps identify issues with the Phadia 2500 output or the data transmission process.

## Key Components:

1. PhadiaTelemetryHandler:
   - Handles the core logic for processing telemetry data.
   - Implements a producer-consumer pattern using BlockingCollection for efficient data processing.
   - Sends data to Event Hub and gRPC endpoints with retry logic.

2. FileProcessingService:
   - Monitors a specified directory for new files.
   - Processes XML and JSON files containing allergen data concurrently.
   - Uses SemaphoreSlim to limit the degree of parallelism in file processing.
   - Keeps track of processed files using a ConcurrentDictionary to avoid reprocessing.

3. TelemetryServiceClient:
   - Handles communication with Azure Event Hub.
   - Implements retry logic for failed Event Hub transmissions.

4. GrpcClient:
   - Manages communication with the gRPC endpoint.
   - Implements a circuit breaker pattern for resilience.

5. HangfireJobsSetup:
   - Configures recurring jobs using Hangfire for scheduled file processing.

## TPL Capabilities Implemented:

1. Task-based Asynchronous Pattern (TAP):
   - Extensive use of async/await throughout the codebase.

2. Parallel Processing:
   - Custom implementation using Tasks and SemaphoreSlim for parallel file processing.

3. Concurrent Collections:
   - BlockingCollection<T> for the data queue in PhadiaTelemetryHandler.
   - ConcurrentDictionary<TKey, TValue> for tracking processed files.

4. Task Coordination:
   - Task.WhenAll for waiting on multiple asynchronous operations.
   - TaskCompletionSource<T> for signaling completion of processing.

5. Cancellation Support:
   - CancellationTokenSource and CancellationToken for operation cancellation.

6. Exception Handling:
   - Try-catch blocks within async methods for handling asynchronous exceptions.

7. Long-running Tasks:
   - Background processing task started using Task.Run.

8. Atomic Operations:
   - Interlocked class for thread-safe counter operations.

9. Asynchronous I/O Operations:
   - Asynchronous file reading using FileStream and StreamReader.

10. Task Timeouts:
    - Task.WaitAsync with CancellationTokenSource for implementing timeouts.

## Configuration (appsettings.json):
```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.Hosting.Lifetime": "Information"
    }
  },
  "Telemetry": {
    "EventHubConnectionString": "EventHub_Connection_String",
    "EventHubName": "EventHub_Name",
    "DirectoryPath": "C:/Phadia2500/Files"
  },
  "gRPC": {
    "BaseURI": "grpc://127.0.0.1:8081"
  },
  "Hangfire": {
    "JobIntervalMinutes": 5
  },
  "Elasticsearch": {
    "Uri": "http://localhost:9200",
    "IndexFormat": "phadia-telemetry-logs-{0:yyyy.MM}"
  }
}
```

This service provides a robust, scalable solution for processing allergen telemetry data, with features for resilience, monitoring, and easy deployment as a Windows Service. It efficiently handles concurrent processing of files and telemetry data, manages shared resources safely, and provides responsive asynchronous operations.

# To set up the service:
1. Ensure all required NuGet packages are installed.
2. Configure appsettings.json with appropriate values for the required services(Azure Event Hub, gRPC consumer API, and Elasticsearch).
3. Build the project in Release mode.
4. Use the provided install_service.bat script to install and start the Windows Service.
5. Ensure the Event Hub, gRPC server, and Elasticsearch instances are set up and accessible.

This service provides a robust, scalable solution for processing allergen telemetry data, with features for resilience, monitoring, and easy deployment as a Windows Service.
