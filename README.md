# Phadia Telemetry Service

Service Summary:
The Phadia Telemetry Service is a Windows background service designed to interface with the Phadia 2500 Laboratory System, a high-throughput automated system for allergy and autoimmunity testing. This service processes the output files generated by the Phadia 2500, transmitting the data for storage and further analysis.

# Key Points:

1. Data Source: 
   - The service processes files output by the Phadia 2500 Laboratory System.
   - These files likely contain crucial allergy and autoimmunity test results.

2. File Processing:
   - The service monitors a specified directory for new files from the Phadia 2500.
   - It can handle both XML and JSON file formats, suggesting flexibility in data output from the machine or potential for future changes.

3. Data Transmission:
   - Processed data is sent to an Azure Event Hub, which can act as a buffer for high-volume data ingestion.
   - Data is also sent to a gRPC endpoint, allowing for real-time data streaming to other services.

4. Analytical Services Integration:
   - By transmitting data to Event Hub and gRPC endpoints, the service enables integration with multiple analytical services.
   - This setup allows for real-time analysis, batch processing, or both, depending on the connected analytical services.

5. Resilience and Scalability:
   - The service implements retry mechanisms and circuit breakers to ensure reliable data transmission even in case of temporary network issues.
   - Use of Azure Event Hub allows for scalable data ingestion, which is crucial for high-throughput systems like the Phadia 2500.

6. Monitoring and Logging:
   - Extensive logging to Elasticsearch allows for monitoring of the data flow from the Phadia 2500 through your service.
   - Metrics tracking can help identify issues with the Phadia 2500 output or the data transmission process.

Importance:
1. Automation: This service automates the process of collecting and transmitting data from the Phadia 2500, reducing manual intervention and potential for human error.

2. Real-time Data Access: By quickly processing and transmitting data, it enables near real-time access to test results for clinicians and researchers.

3. Data Integrity: The service ensures that all data from the Phadia 2500 is captured and transmitted, maintaining the integrity of the testing process.

4. Scalability: As designed, the service should be able to handle the high throughput of the Phadia 2500 (up to 1000 tests per day), and scale further if needed.

5. Analytics Enablement: By feeding data into systems designed for analytics, it enables advanced analysis of allergy and autoimmunity test results, potentially leading to new insights or research opportunities.

This service forms a crucial link between the Phadia 2500 Laboratory System and your broader data analysis infrastructure. It ensures that the valuable allergy and autoimmunity data generated by the Phadia 2500 is reliably captured, transmitted, and made available for further analysis and use.

#  Service Overview:
The Phadia Telemetry Service is a Windows background service designed to process allergen telemetry data. It monitors a specified directory for new files, processes them, and sends the data to both an Event Hub and a gRPC endpoint.

Key Components:

1. PhadiaTelemetryHandler:
   - Handles the core logic for processing telemetry data.
   - Sends data to Event Hub and gRPC endpoints.
   - Implements retry logic for failed transmissions.

2. FileProcessingService:
   - Monitors a specified directory for new files.
   - Processes XML and JSON files containing allergen data.
   - Keeps track of processed files to avoid reprocessing.

3. TelemetryServiceClient:
   - Handles communication with Azure Event Hub.
   - Implements retry logic for failed Event Hub transmissions.

4. GrpcClient:
   - Manages communication with the gRPC endpoint.
   - Implements a circuit breaker pattern for resilience.

5. HangfireJobsSetup:
   - Configures recurring jobs using Hangfire for scheduled file processing.

Functionality:
1. File Monitoring and Processing:
   - Regularly checks a specified directory for new files.
   - Processes XML and JSON files containing allergen telemetry data.
   - Avoids reprocessing already processed files.

2. Data Transmission:
   - Sends processed data to Azure Event Hub.
   - Transmits data to a gRPC endpoint.
   - Implements retry mechanisms and circuit breakers for resilient communication.

3. Logging and Metrics:
   - Uses Serilog for structured logging.
   - Logs to both console and Elasticsearch.
   - Tracks metrics such as processed files, failed files, and transmitted data.

4. Scheduled Jobs:
   - Uses Hangfire to schedule regular file processing jobs.

Required Endpoints and Services:
1. Azure Event Hub:
   - Endpoint: Specified in configuration as EventHubConnectionString
   - Purpose: Receives processed allergen telemetry data

2. gRPC Service:
   - Endpoint: Specified in configuration as gRPC:BaseURI
   - Purpose: Receives processed allergen telemetry data

3. Elasticsearch:
   - Endpoint: Specified in configuration (default: http://localhost:9200)
   - Purpose: Stores application logs

Configuration (appsettings.json):
```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.Hosting.Lifetime": "Information"
    }
  },
  "Telemetry": {
    "EventHubConnectionString": "EventHub_Connection_String",
    "EventHubName": "EventHub_Name",
      "DirectoryPath": "C:/Phadia2500/Files"
  },
  "gRPC": {
    BaseURI": "grpc://127.0.0.1:8081"
  },
  "Hangfire": {
    "JobIntervalMinutes": 5
  },
  "Elasticsearch": {
    "Uri": "http://localhost:9200",
    "IndexFormat": "phadia-telemetry-logs-{0:yyyy.MM}"
  }
}
```

# Files:
1. Program.cs: Main entry point, configures services and dependencies.
2. PhadiaTelemetryHandler.cs: Core logic for processing and transmitting data.
3. FileProcessingService.cs: Handles file monitoring and processing.
4. TelemetryServiceClient.cs: Manages Event Hub communication.
5. GrpcClient.cs: Manages gRPC communication.
6. HangfireJobsSetup.cs: Configures Hangfire jobs.
7. AllergenTelemetryData.cs: Data model for allergen telemetry.
8. TelemetryOptions.cs, GrpcOptions.cs: Configuration option classes.
9. Metrics.cs: Tracks service metrics.
10. Various interface files (IGrpcClient.cs, IPhadiaTelemetryHandler.cs, ITelemetryServiceClient.cs).

# To set up the service:
1. Ensure all required NuGet packages are installed.
2. Configure appsettings.json with appropriate values.
3. Build the project in Release mode.
4. Use the provided install_service.bat script to install and start the Windows Service.
5. Ensure the Event Hub, gRPC server, and Elasticsearch instances are set up and accessible.

This service provides a robust, scalable solution for processing allergen telemetry data, with features for resilience, monitoring, and easy deployment as a Windows Service.
